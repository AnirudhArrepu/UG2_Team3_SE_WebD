# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rmq3cfo_sXxyz0m67ByGcfClIe7Z3u_O
"""

pip install PyPDF2 chromadb google-generativeai pyngrok

import requests
from PyPDF2 import PdfReader
from langchain.text_splitter import SpacyTextSplitter
from sentence_transformers import SentenceTransformer
import chromadb
from concurrent.futures import ThreadPoolExecutor
from flask import Flask, request, jsonify
from dotenv import load_dotenv
import google.generativeai as genai
import os

from pyngrok import ngrok
ngrok.set_auth_token("2l5jeNkFj6bxckYshUA36YYMTEk_2zhyVjuCejoN3yFrq1qUp")

load_dotenv()

# Get tokens from environment variables
gemini_api_key = "AIzaSyCntb4idjgKUg8zgZRjT9QQSBsKrPXo2S4"

genai.configure(api_key=gemini_api_key)

# Initialize Sentence Transformer embedder and ChromaDB client
embedder = SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')
client = chromadb.Client()
collection = client.create_collection("docs")

def getchunks(text):
    splitter = SpacyTextSplitter(
        separator="\n\n",
        chunk_size=100,
        chunk_overlap=20,
        length_function=len,
    )
    return splitter.split_text(text)

def load_data_convert_to_chunks(pdf):
    text = ""
    for page in pdf.pages:
        text += page.extract_text()
    return getchunks(text)

def generate_embeddings(text):
    return embedder.encode(text, convert_to_tensor=True)

def store_to_db(text):
    for i, chunk in enumerate(text):
        embedding = generate_embeddings(chunk).tolist()
        collection.add(
            documents=[chunk],
            embeddings=[embedding],
            ids=[f'{i}']
        )

def get_related_query(query):
    embeds = generate_embeddings(query)
    results = collection.query(
        query_texts=query,
        n_results=3
    )
    return results['documents']

def call_gemini_api(prompt):
    model = genai.GenerativeModel("gemini-1.5-flash")
    response = model.generate_content(prompt)
    print(response.text)

    return response.text

def get_answer(query, context):
    prompt = f"""
        Context: {context}
        Query: {query}

        Based on the provided context, explain the answer in less than 100 words, focusing on the key concepts and providing a comprehensive explanation.
        Answer:
    """
    return call_gemini_api(prompt)

def answer_query(query):
    context = get_related_query(query)
    answer = get_answer(query, context)
    return answer

def server_multiple_pdfs(pdfs):
    with ThreadPoolExecutor() as executor:
        list(executor.map(lambda pdf: store_to_db(load_data_convert_to_chunks(pdf)), pdfs))

# pdf1 = PdfReader('../testing_pdf.pdf')
# server_multiple_pdfs([pdf1])

text = "Marine life is a diverse and essential part of Earth's ecosystems, encompassing a vast array of species ranging from microscopic plankton to the majestic whales. The oceans cover about 71% of the planet’s surface and play a critical role in regulating the global climate, producing oxygen, and providing resources for countless species. Marine organisms can be found in a variety of habitats, including coral reefs, deep-sea trenches, coastal estuaries, and open ocean waters. Each of these ecosystems supports unique communities of species that interact with one another and their environment in intricate ways. The oceans are home to billions of species, including fish, marine mammals like dolphins and whales, sea turtles, jellyfish, and various invertebrates like octopuses and sea stars. Phytoplankton, which are microscopic plants, form the base of the marine food web and produce a significant portion of the world’s oxygen. Fish and other marine animals are vital to global food security and are a primary source of protein for billions of people worldwide. Coral reefs, known for their breathtaking biodiversity, are often referred to as the rainforests of the sea, as they support a wide variety of species and provide essential ecosystem services, such as coastal protection and carbon sequestration. However, marine life faces numerous threats from human activities. Overfishing is depleting fish stocks, while pollution, especially plastic waste, is causing widespread harm to marine animals. Plastics and other debris are often ingested by marine creatures, leading to health problems or death. Climate change is exacerbating these issues by warming ocean waters, causing coral bleaching, and altering migration patterns for many species. Ocean acidification, caused by the absorption of excess carbon dioxide from the atmosphere, is another significant challenge for marine life, as it weakens the shells of many marine organisms and disrupts food chains. In addition, habitat destruction from practices like bottom trawling and coastal development is damaging vital ecosystems like coral reefs and mangroves. Despite these challenges, conservation efforts are underway to protect marine life. Marine protected areas (MPAs) are one of the most effective tools for preserving biodiversity, providing safe havens for marine species to thrive without the pressure of human interference. Sustainable fishing practices, such as establishing catch limits and implementing no-catch zones, help to ensure that fish populations remain healthy and that marine ecosystems are not overexploited. Efforts to reduce plastic pollution include initiatives to clean up beaches, reduce single-use plastics, and promote alternatives. Climate action, such as global agreements to reduce greenhouse gas emissions, is also crucial for maintaining ocean health. Education and awareness campaigns are essential for helping people understand the importance of protecting marine life, as well as how individual actions can make a difference, such as reducing plastic waste, supporting sustainable seafood, and advocating for stronger environmental protections. The interconnectedness of marine ecosystems means that preserving marine life benefits not only the ocean itself but also the climate, biodiversity, and the millions of people who rely on the ocean for food and livelihood. Protecting marine life is critical for the health of the planet, and through collective action, we can ensure that these ecosystems continue to thrive for future generations."

store_to_db(getchunks(text))

# Set up Flask app
app = Flask(__name__)

@app.route("/addData", methods=["POST"])
def update_knowledge_base():
    data = request.json
    newData = data.get("newdata")
    if newData:
        chunks = getchunks(newData)
        store_to_db(chunks)
        return jsonify({"message": "Data added successfully"}), 200
    else:
        return jsonify({"message": "Couldn't add text"}), 400

@app.route("/query", methods=["POST"])
def query_api():
    data = request.json
    query = data.get("query")
    if query:
        answer = answer_query(query)
        print(answer)
        return jsonify({"query": query, "answer": answer}), 200
    else:
        return jsonify({"error": "No query provided"}), 400


if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))

    # Start a ngrok tunnel
    public_url = ngrok.connect(port)
    print(f" * Ngrok tunnel running at: {public_url}")

    # Run the Flask app
    app.run(host='0.0.0.0', port=port)

